name: PR Quality Reporter
on:
  pull_request:
    types: [closed]

jobs:
  report:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      checks: read
      pull-requests: write
    steps:
      - name: Report required checks
        uses: actions/github-script@v6
        with:
          script: |
            const knownRequiredChecks = [
              'CodeQL',
              'Validate composer.json and PHP Coding style',
              'Validate language files are UTF-8 encoded'
            ];

            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });

            const requiredChecks = checks.check_runs.filter(check =>
              knownRequiredChecks.some(name => check.name.includes(name))
            );

            if (requiredChecks.length > 0) {
              const message = [
                '## PR Quality Report',
                '### Required Checks:',
                ...requiredChecks.map(c => `- ${c.name} ${c.conclusion === 'success' ? '✅ Passed' : '❌ Failed'}`),
                '',
                `✅ Passed: ${requiredChecks.filter(c => c.conclusion === 'success').length}/${requiredChecks.length}`
              ].join('\n');

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            }
